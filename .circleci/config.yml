version: 2

workflows:
  version: 2
  configstore:
    jobs:
      - test-py35
      - test-py36
      - test-py37
      - test-py27
      - check

jobs:

  test-py37:
    docker:
      - image: circleci/python:3.7
    working_directory: ~/configstore
    steps:
      - checkout
      - restore_cache:
          key: configstore-py37-v2
      - run:
          name: Install CI tools
          command: |
            python3.7 -m venv venv
            venv/bin/pip install tox
      - run:
          name: Test with Python 3.7
          command: venv/bin/tox -e py37 -- --junitxml=~/reports/tox/coverage.xml
      - run:
          name: Run tests with coverage
          command: venv/bin/tox -e coverage
      - save_cache:
          key: configstore-py37-v2
          paths:
            - venv
            - .tox
      - store_test_results:
          path: ~/reports

  test-py36:
    docker:
      - image: circleci/python:3.6
    working_directory: ~/configstore
    steps:
      - checkout
      - restore_cache:
          key: configstore-py36-v2
      - run:
          name: Install CI tools
          command: |
            python3.6 -m venv venv
            venv/bin/pip install tox
      - run:
          name: Test with Python 3.6
          command: venv/bin/tox -e py36 -- --junitxml=~/reports/tox/coverage.xml
      - save_cache:
          key: configstore-py36-v2
          paths:
            - venv
            - .tox
      - store_test_results:
          path: ~/reports

  test-py35:
    docker:
      - image: circleci/python:3.5
    working_directory: ~/configstore
    steps:
      - checkout
      - restore_cache:
          key: configstore-py35-v2
      - run:
          name: Install CI tools
          command: |
            python3.5 -m venv venv
            venv/bin/pip install tox
      - run:
          name: Test with Python 3.5
          command: venv/bin/tox -e py35 -- --junitxml=~/reports/tox/coverage.xml
      - save_cache:
          key: configstore-py35-v2
          paths:
            - venv
            - .tox
      - store_test_results:
          path: ~/reports

  test-py27:
    docker:
      # This image contains Python 3.6 (to install flit) and 2.7 (to run tests)
      - image: circleci/python:3.6
    working_directory: ~/configstore
    steps:
      - checkout
      - restore_cache:
          key: configstore-py27-v2
      - run:
          name: Install CI tools
          command: |
            python3.6 -m venv venv
            venv/bin/pip install tox
      - run:
          name: Test with Python 2.7
          command: |
            venv/bin/tox --sdistonly
            venv/bin/tox -e py27 -- --junitxml=~/reports/tox/coverage.xml
      - save_cache:
          key: configstore-py27-v2
          paths:
            - venv
            - .tox
      - store_test_results:
          path: ~/reports

  check:
    docker:
      - image: circleci/python:3.7
    working_directory: ~/configstore
    steps:
      - checkout
      - restore_cache:
          key: configstore-check-v2
      - run:
          name: Install CI tools
          command: |
            python3.7 -m venv venv
            venv/bin/pip install tox
      - run:
          name: Check packaging and dependencies
          command: venv/bin/tox -e pkg
      - save_cache:
          key: configstore-check-v2
          paths:
            - venv
            - .tox
